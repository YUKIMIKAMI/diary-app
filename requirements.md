# 要件定義書 - AI日記マインドマップアプリケーション

## 1. プロジェクト概要

### 1.1 プロダクトビジョン
日記を書くことから始まり、AIの力を借りて自己理解を深め、人生の軌跡を可視化する革新的な日記アプリケーション。

### 1.2 主要コンセプト
- **簡単スタート**: シンプルなUIで日記を書き始める
- **自動マインドマップ化**: 日記が自動的にマインドマップに変換される
- **AI駆動の自己探求**: AIが質問を生成し、深い自己理解を促進
- **人生の可視化**: 時系列でマインドマップを結合し、人生の全体像を把握

## 2. 機能要件

### 2.1 無料プラン機能

#### 2.1.1 日記記入機能
- シンプルなテキストエディタで日記を記入
- 記入日時の自動記録
- テキストデータのDB保存

#### 2.1.2 マインドマップ自動生成
- 日記送信後、自動でマインドマップページへ遷移
- 日記内容をノード化したマインドマップの生成
- JSON形式でのデータ構造化

#### 2.1.3 AI質問生成機能
- 日記内容に基づいた関連質問の自動生成
- 質問ノードのマインドマップへの追加
- 質問への回答は任意（放置可能）

#### 2.1.4 時系列管理
- 過去の日記への質問回答機能
- 回答時の日時も記録
- 過去の日記と質問の閲覧機能

#### 2.1.5 検索機能
- マインドマップページ内での日記検索
- キーワード検索
- 日付範囲指定検索

### 2.2 有料プラン機能

#### 2.2.1 画像保存機能
- 日記への画像添付
- 画像専用DBへの保存
- 画像付き日記のマインドマップ表示

#### 2.2.2 AI相談モード
- ChatGPT風の対話インターフェース
- 過去の日記データを基にしたパーソナライズされた回答
- コンテキストを理解した深い対話

#### 2.2.3 感情分析機能
- 日記の感情分析とベクトル化
- マインドマップノードへの感情カラーリング
- 感情マーカーの表示（ノード右上）
- 月別・年別の感情推移グラフ
- 感情ベクトルのDB保存

#### 2.2.4 単語集計機能
- 頻出単語の抽出と分析
- 月別・年別の単語使用統計
- 棒グラフ表示
- ワードクラウド生成

#### 2.2.5 マインドマップ結合機能
- 月別マインドマップの生成
- 年別マインドマップの生成
- 全期間統合マインドマップ
- カテゴリ別ノード分類（趣味、人間関係、仕事など）
- 人生の縮図としての可視化

#### 2.2.6 対話型日記入力
- AI対話による日記作成支援
- 「今日はどんな一日でしたか？」などの導入質問
- 回答に基づいた追加質問の生成
- 記憶の引き出しと深堀り支援

## 3. 非機能要件

### 3.1 パフォーマンス
- マインドマップの描画: 1000ノードまで3秒以内
- 検索レスポンス: 2秒以内
- API応答時間: 平均500ms以内

### 3.2 セキュリティ
- エンドツーエンド暗号化（日記データ）
- OAuth 2.0認証
- GDPR準拠のデータ管理

### 3.3 スケーラビリティ
- ユーザー数: 初期10,000人、最大100,000人対応
- データストレージ: 自動スケーリング対応

### 3.4 ユーザビリティ
- レスポンシブデザイン（PC/タブレット/スマホ対応）
- 直感的なUI/UX
- アクセシビリティ対応（WCAG 2.1 Level AA）

## 4. データモデル

### 4.1 主要エンティティ

#### User（ユーザー）
```
- user_id: UUID
- email: string
- username: string
- subscription_type: enum (free/premium)
- created_at: timestamp
- updated_at: timestamp
```

#### DiaryEntry（日記エントリー）
```
- entry_id: UUID
- user_id: UUID (FK)
- content: text
- created_at: timestamp
- updated_at: timestamp
- emotion_vector: jsonb (有料プランのみ)
```

#### Question（質問）
```
- question_id: UUID
- entry_id: UUID (FK)
- question_text: text
- created_at: timestamp
```

#### Answer（回答）
```
- answer_id: UUID
- question_id: UUID (FK)
- answer_text: text
- answered_at: timestamp
```

#### Image（画像）
```
- image_id: UUID
- entry_id: UUID (FK)
- image_url: string
- uploaded_at: timestamp
```

#### MindMapNode（マインドマップノード）
```
- node_id: UUID
- entry_id: UUID (FK)
- node_type: enum (diary/question/answer)
- position: jsonb
- connections: jsonb
- metadata: jsonb
```

## 5. 技術スタック

### 5.1 フロントエンド
- **フレームワーク**: Next.js 14 (App Router)
- **言語**: TypeScript
- **UIライブラリ**: React 18
- **スタイリング**: Tailwind CSS + shadcn/ui
- **マインドマップ**: React Flow or vis.js
- **状態管理**: Zustand
- **データフェッチング**: TanStack Query
- **フォーム**: React Hook Form + Zod
- **グラフ/チャート**: Recharts
- **ワードクラウド**: react-wordcloud

### 5.2 バックエンド
- **フレームワーク**: FastAPI (Python)
- **言語**: Python 3.11+
- **ORM**: SQLAlchemy 2.0
- **バリデーション**: Pydantic v2

### 5.3 AI/ML
- **LLM API**: OpenAI GPT-4 API
- **感情分析**: Transformers (Japanese BERT)
- **埋め込みベクトル**: OpenAI Embeddings API
- **自然言語処理**: spaCy (GiNZA for Japanese)

### 5.4 データベース
- **メインDB**: PostgreSQL 15
- **ベクトルDB**: pgvector (PostgreSQL extension)
- **画像ストレージ**: AWS S3 or Cloudflare R2
- **キャッシュ**: Redis
- **全文検索**: PostgreSQL Full Text Search

### 5.5 インフラ/DevOps
- **ホスティング**: 
  - フロントエンド: Vercel
  - バックエンド: AWS ECS or Railway
- **CI/CD**: GitHub Actions
- **モニタリング**: Sentry + Datadog
- **認証**: Auth0 or Supabase Auth

## 6. システムアーキテクチャ

### 6.1 全体構成
```
┌─────────────────┐
│   Frontend      │
│   (Next.js)     │
└────────┬────────┘
         │ HTTPS
         ↓
┌─────────────────┐
│   API Gateway   │
│   (FastAPI)     │
└────────┬────────┘
         │
    ┌────┴────┐
    ↓         ↓
┌─────────┐ ┌─────────┐
│PostgreSQL│ │   S3    │
│+pgvector │ │ (画像)  │
└─────────┘ └─────────┘
    ↑
┌─────────────────┐
│   AI Services   │
│ (OpenAI/BERT)   │
└─────────────────┘
```

### 6.2 API設計

#### 主要エンドポイント
```
POST   /api/diary/entries          # 日記作成
GET    /api/diary/entries          # 日記一覧取得
GET    /api/diary/entries/{id}     # 日記詳細取得
POST   /api/diary/entries/{id}/questions  # 質問生成
POST   /api/questions/{id}/answers        # 質問回答
GET    /api/mindmap/{entry_id}            # マインドマップデータ取得
POST   /api/mindmap/merge                 # マインドマップ結合
POST   /api/analysis/emotion              # 感情分析
GET    /api/analysis/words                # 単語集計
POST   /api/chat/consult                  # AI相談
```

## 7. 開発フェーズ

### Phase 1: MVP（2-3ヶ月）
- 基本的な日記記入機能
- シンプルなマインドマップ表示
- 基本的な質問生成
- ユーザー認証

### Phase 2: 拡張機能（2ヶ月）
- 検索機能
- 画像アップロード
- 感情分析基礎
- サブスクリプション管理

### Phase 3: AI機能強化（2ヶ月）
- AI相談モード
- 高度な感情分析
- 単語集計・可視化
- マインドマップ結合

### Phase 4: 最適化と拡張（継続的）
- 対話型日記入力
- パフォーマンス最適化
- モバイルアプリ開発
- 多言語対応

## 8. 成功指標（KPI）

- **DAU（Daily Active Users）**: 30%以上
- **継続率**: 3ヶ月後40%以上
- **有料プラン転換率**: 10%以上
- **平均セッション時間**: 15分以上
- **月間日記作成数**: ユーザーあたり20件以上

## 9. リスクと対策

### 技術的リスク
- **マインドマップのパフォーマンス**: ノード数制限とページネーション実装
- **AI APIコスト**: キャッシング戦略とレート制限
- **データプライバシー**: 暗号化とゼロ知識アーキテクチャの検討

### ビジネスリスク
- **競合サービスとの差別化**: マインドマップ機能の独自性強化
- **ユーザー獲得**: フリーミアムモデルの最適化

## 10. 今後の検討事項

- 音声入力対応
- コラボレーション機能（家族・友人との共有）
- エクスポート機能（PDF、画像）
- オフライン対応
- ウェアラブルデバイス連携

## 11. 技術選定の根拠

### 11.1 フロントエンド技術の選定理由

#### Next.js 14を選択した理由
- **パフォーマンス**: Server Componentsによる高速な初期表示
- **開発効率**: App Routerによる直感的なルーティング
- **SEO最適化**: SSR/SSGによる検索エンジン対応
- **エコシステム**: Vercelとの統合でデプロイが簡単

#### React Flowを選択した理由
- **インタラクティブ性**: ドラッグ&ドロップ、ズーム、パンに対応
- **カスタマイズ性**: ノードとエッジの外観を自由に設計可能
- **パフォーマンス**: 仮想化により大量ノードでも高速
- **活発な開発**: 継続的なアップデートとサポート

### 11.2 バックエンド技術の選定理由

#### FastAPIを選択した理由
- **型安全性**: Pydanticによる自動バリデーション
- **AI統合**: Python生態系のAI/MLライブラリと完全互換
- **非同期対応**: 高い同時接続処理能力
- **開発速度**: 自動APIドキュメント生成で開発効率向上

#### PostgreSQL + pgvectorを選択した理由
- **ベクトル検索**: 感情分析結果や意味的類似性検索に対応
- **ACID準拠**: 日記データの整合性を保証
- **拡張性**: パーティショニングによる大規模データ対応
- **コスト効率**: オープンソースで運用コスト削減

### 11.3 AI/ML技術の選定理由

#### OpenAI GPT-4を選択した理由
- **多機能性**: 質問生成、相談、対話型入力すべてに対応
- **日本語能力**: 自然な日本語での対話が可能
- **コンテキスト理解**: 長文の日記でも文脈を維持
- **API安定性**: 商用利用に耐える信頼性

#### Japanese BERTを選択した理由
- **日本語特化**: 日本語の感情分析に最適化
- **軽量**: GPT-4より低コストで感情分析専用処理
- **ローカル実行**: プライバシー保護とレスポンス向上

## 12. 代替技術の検討

### 12.1 検討した代替案

#### フロントエンド
- **Vue.js + Nuxt**: 学習曲線は緩やかだが、エコシステムがReactより小さい
- **SvelteKit**: 高性能だが、マインドマップライブラリの選択肢が限定的
- **Angular**: エンタープライズ向けだが、本プロジェクトには過剰

#### バックエンド
- **Django**: フルスタックだが、APIに特化したFastAPIの方が適切
- **Node.js (Express/Fastify)**: 高速だが、AI/MLライブラリとの統合が複雑
- **Go (Gin/Echo)**: 超高速だが、AI生態系が未成熟

#### データベース
- **MongoDB**: 柔軟だが、ベクトル検索のネイティブサポートなし
- **Pinecone**: ベクトル検索専用だが、追加コストと複雑性
- **Elasticsearch**: 全文検索に優れるが、ベクトル検索は補助的